<!DOCTYPE html>
<html>
<head>
  <title>openlayers6结合echarts4实现迁徙图</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/css/ol.css"
    type="text/css">
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/build/ol.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.js"></script>
  <!-- <script src="js/ol-echarts.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/ol3-echarts/dist/ol3Echarts.js"></script>
  <script src="https://files.cnblogs.com/files/wwj007/ol-echarts.js"></script>
  <!-- ol-echarts.js文件可npm下载,上面引用了我账号文件 -->
  <!-- 参考地址：https://www.npmjs.com/package/ol-echarts/v/1.3.6 -->
  <!-- 文章来源：https://www.cnblogs.com/giserhome/archive/2020/07/26/13379672.html -->
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    var map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: 'http://cache1.arcgisonline.cn/arcgis/rest/services/ChinaOnline' +
              'StreetPurplishBlue/MapServer/tile/{z}/{y}/{x}'
          })
        })
      ],
      view: new ol.View({
        center: [116.55406673632812, 39.94828066015626],
        projection: 'EPSG:4326',
        zoom: 5
      })
    });
    //迁徙图图层初始化
    var echartslayer = new ol3Echarts(getOption());
    echartslayer.appendTo(map)
    function getOption() {
      var geoCoordMap = {
        '上海': [121.4648, 31.2891],
        '北京': [116.4551, 40.2539],
        '南宁': [108.479, 23.1152],
        '南昌': [116.0046, 28.6633],
        '大连': [122.2229, 39.4409],
        '广州': [113.5107, 23.2196],
      };
      var BJData = [
        [{ name: '北京' }, { name: '上海', value: 95 }],
        [{ name: '北京' }, { name: '广州', value: 90 }],
        [{ name: '北京' }, { name: '大连', value: 80 }],
        [{ name: '北京' }, { name: '南宁', value: 70 }],
        [{ name: '北京' }, { name: '南昌', value: 60 }],
      ];
      var convertData = function(data) {
        var res = [];
        for (var i = 0; i < data.length; i++) {
          var dataItem = data[i];
          var fromCoord = geoCoordMap[dataItem[1].name];
          var toCoord = geoCoordMap[dataItem[0].name];
          if (fromCoord && toCoord) {
            res.push({
              toName: dataItem[0].name,
              fromName: dataItem[1].name,
              coords: [fromCoord, toCoord],
              value: dataItem[1].value
            });
          }
        }
        return res;
      };
      var color = ['#a6c84c', '#ffa022', '#46bee9', '#61b8ff', '#0000e1', '#fa00fa', 'pink', '#880015'];
      var series = [];
      series.push(
        {
          type: 'lines',
          zlevel: 2,
          effect: {
            show: true,
            period: 6,
            trailLength: 0,
            symbol: 'arrow',
            symbolSize: 10
          },
          lineStyle: {
            normal: {
              color: function(params) {
                console.log(params.value, params.data.fromName);
                return color[parseInt((params.value - 60) / 5)]
              },
              width: 2,
              opacity: 0.4,
              curveness: 0.2
            }
          },
          data: convertData(BJData)
        },
        {
          type: 'effectScatter',
          coordinateSystem: 'geo',
          zlevel: 2,
          rippleEffect: {
            brushType: 'stroke'
          },
          label: {
            normal: {
              show: true,
              position: 'right',
              formatter: '{b}'
            }
          },
          symbolSize: 15,
          itemStyle: {
            normal: {
              color: function(params) {
                return color[parseInt((params.value[2] - 60) / 5)]
              },
            }
          },
          data: BJData.map(function(dataItem) {
            return {
              name: dataItem[1].name,
              value: geoCoordMap[dataItem[1].name].concat([dataItem[1].value])
            };
          })
        });
      return {
        tooltip: {
          trigger: 'item'
        },
        series: series
      };
    }
  </script>
</body>
</html>
